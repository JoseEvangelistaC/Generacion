@using Generacion.Models.DashBoard;
@using Generacion.Models.Usuario;
@{
    ViewBag.Title = "Dashboard";
    List<DetalleOperario> listaOperario = ViewData["ListaOperarios"] as List<DetalleOperario>;

    Dictionary<decimal, DashboardDetalleFiltro> datosFiltroCentrifugo = ViewData["datosFiltroCentrifugo"] as Dictionary<decimal, DashboardDetalleFiltro>;

}
<style>
    .hidden {
        display: none;
    }

    input {
        height: 23px;
        width: 100px;
        border: none;
    }

    .table td, .table th {
        padding: 0rem;
    }

    .table {
        
        margin: 0;
        color: black;
    }

        .table thead, .table tbody {
            text-align: center;
        }

    .contendor-tablas-iguales{
        display: flex;
        width: 50%;
    }
</style>
<div>
    <div id="div1" style="width: 50%;">
        <table id="FiltroCentrifugo" class="table table-bordered">
            <thead style="text-align: center;">
                <tr>
                    <th rowspan="2">CAMBIO</th>
                    <th colspan="5">FILTRO CENTRIFUGO (1000 Hrs.)</th>
                </tr>
                <tr>
                    <th>UNIDAD</th>
                    <th>FECHA</th>
                    <th>Hrs. OP.</th>
                    <th>ESPESOR</th>
                    <th>EJECUTOR</th>
                </tr>
            </thead>
            <tbody>
                @if (datosFiltroCentrifugo.ContainsKey(1))
                {
                    <tr id="FiltroCentrifugoEG1">
                        <td><input id-class="ProximaHoraCambio" id="ProximaHoraCambio1" type="number" value="@datosFiltroCentrifugo[1].ProximaHoraCambio"  disabled></td>
                        <td style="display: flex;padding: 0 0 0 5px;"> EG<input style="width: 50px;" id-class="NumeroGenerador" type="number" min="1" max="2" disabled value="1"></td>
                        <td><input id-class="fecha" id="fechaInput" value="@datosFiltroCentrifugo[1].Fecha.Split(' ')[0]"></td>
                        <td><input id-class="HorasOperacion" value="@datosFiltroCentrifugo[1].HorasOperacion" type="number" id="HorasOperacion1" oninput="actualizarProximaHora('1')"></td>
                        <td><input id-class="espesor" value="@datosFiltroCentrifugo[1].Espesor" type="number"></td>
                        <td style="display:flex;">
                            <input id-class="OperadorEjecutor" id="idOperarioEG1" value="@datosFiltroCentrifugo[1].OperadorEjecutor">
                            <select id="ListaOperariosEG1" style="height: 23px">
                                <option value="">-OP-</option>
                                @foreach (var item in listaOperario)
                                {
                                    <option value="@item.IdOperario">@(item.Apellidos + " " + item.Nombre)</option>
                                }
                            </select>
                        </td>
                    </tr>
                }
                else
                {
                    <tr id="FiltroCentrifugoEG1">
                        <td><input id-class="ProximaHoraCambio" id="ProximaHoraCambio1" type="number" disabled></td>
                        <td style="display: flex;padding: 0 0 0 5px;"> EG<input style="width: 50px;" id-class="NumeroGenerador" type="number" min="1" max="2" disabled value="1"></td>
                        <td><input id-class="fecha" id="fechaInput"></td>
                        <td><input id-class="HorasOperacion" type="number" id="HorasOperacion1" oninput="actualizarProximaHora('1')"></td>
                        <td><input id-class="espesor" type="number"></td>
                        <td style="display:flex;">
                            <input id-class="OperadorEjecutor" id="idOperarioEG1">
                            <select id="ListaOperariosEG1" style="height: 23px">
                                <option value="">-OP-</option>
                                @foreach (var item in listaOperario)
                                {
                                    <option value="@item.IdOperario">@(item.Apellidos + " " + item.Nombre)</option>
                                }
                            </select>
                        </td>
                    </tr>
                }
                @if (datosFiltroCentrifugo.ContainsKey(2))
                {
                    <tr id="FiltroCentrifugoEG2">
                        <td><input id-class="ProximaHoraCambio" id="ProximaHoraCambio2" type="number" disabled value="@datosFiltroCentrifugo[2].ProximaHoraCambio"></td>
                        <td style="display: flex;padding: 0 0 0 5px;">EG<input type="number" style="width: 50px;" id-class="NumeroGenerador" min="1" max="2" disabled value="2"></td>
                        <td><input id-class="fecha" id="fechaInput2" value="@datosFiltroCentrifugo[2].Fecha.Split(' ')[0]"></td>
                        <td><input id-class="HorasOperacion" type="number" id="HorasOperacion2" oninput="actualizarProximaHora('2')" value="@datosFiltroCentrifugo[2].HorasOperacion"></td>
                        <td><input id-class="espesor" type="number" value="@datosFiltroCentrifugo[2].Espesor"></td>
                        <td style="display:flex;">
                            <input id-class="OperadorEjecutor" id="idOperarioEG2" value="@datosFiltroCentrifugo[2].OperadorEjecutor">
                            <select id="ListaOperariosEG2" style="height: 23px">
                                <option value="">-OP-</option>
                                @foreach (var item in listaOperario)
                                {
                                    <option value="@item.IdOperario">@(item.Apellidos + " " + item.Nombre)</option>
                                }
                            </select>
                        </td>
                    </tr>
                }
                else
                {
                    <tr id="FiltroCentrifugoEG2">
                        <td><input id-class="ProximaHoraCambio" id="ProximaHoraCambio2" type="number" disabled></td>
                        <td style="display: flex;padding: 0 0 0 5px;">EG<input type="number" style="width: 50px;" id-class="NumeroGenerador" min="1" max="2" disabled value="2"></td>
                        <td><input id-class="fecha" id="fechaInput2"></td>
                        <td><input id-class="HorasOperacion" type="number" id="HorasOperacion2" oninput="actualizarProximaHora('2')"></td>
                        <td><input id-class="espesor" type="number"></td>
                        <td style="display:flex;">
                            <input id-class="OperadorEjecutor" id="idOperarioEG2">
                            <select id="ListaOperariosEG2" style="height: 23px">
                                <option value="">-OP-</option>
                                @foreach (var item in listaOperario)
                                {
                                    <option value="@item.IdOperario">@(item.Apellidos + " " + item.Nombre)</option>
                                }
                            </select>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <div>
            <div style="display: flex;text-align: center;">
                <p style="font-weight: bold;color: red;width: 20%;">BESS</p><p style="color: black;width: 80%;font-weight: bold;">DOMINGOS Y FERIADOS NO ACTIVAR</p>
            </div>
        </div>
    </div>
    <div id="div2" class="contendor-tablas-iguales">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th rowspan="2">Fecha</th>
                    <th colspan="2">HORAS DE BUJÍA</th>
                </tr>
                <tr>
                    <th>EG-1</th>
                    <th>EG-2</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th><input type="text" /></th>
                    <td><input type="number" /></td>
                    <td><input type="number" /></td>
                </tr>
            </tbody>
        </table>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th rowspan="2">Fecha</th>
                    <th colspan="2">HORAS DE BUJÍA</th>
                </tr>
                <tr>
                    <th>EG-1</th>
                    <th><input type="number" /></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th><input type="text" /></th>
                    <th>EG-2</th>
                    <td><input type="number" /></td>
                </tr>
            </tbody>
        </table>
    </div>
    <button onclick="guardarDatosFiltro()">Obtener Valores</button>
</div>


<script>
    function actualizarProximaHora(number) {
        var horasOperacion = document.getElementById("HorasOperacion" + number);
        var idOperarioTrabajo = document.getElementById("ProximaHoraCambio" + number);

        idOperarioTrabajo.value = parseInt(horasOperacion.value) + 1000;
    }


    var idOperarioTrabajo = document.getElementById("ListaOperariosEG1");
    idOperarioTrabajo.addEventListener('change', obtenerOperariosSeleccionados);
    var idOperarioTrabajo2 = document.getElementById("ListaOperariosEG2");
    idOperarioTrabajo2.addEventListener('change', obtenerOperariosSeleccionados2);

    function obtenerOperariosSeleccionados() {
        var selectedOption = this.options[this.selectedIndex];
        var id = selectedOption.value;

        if (id != "") {
            var nombreApellido = selectedOption.text.split(' ');
            if (nombreApellido.length < 2) {
                nombreApellido[1] = " ";
            }
            var inputOperario = document.getElementById("idOperarioEG1");

            inputOperario.value = inputOperario.value == "" ? nombreApellido[0][0] + nombreApellido[1][0] : inputOperario.value + '/' + nombreApellido[0][0] + nombreApellido[1][0];
            this.selectedIndex = 0;
        }
    }
    function obtenerOperariosSeleccionados2() {
        var selectedOption = this.options[this.selectedIndex];
        var id = selectedOption.value;

        if (id != "") {
            var nombreApellido = selectedOption.text.split(' ');
            if (nombreApellido.length < 2) {
                nombreApellido[1] = " ";
            }
            var inputOperario = document.getElementById("idOperarioEG2");

            inputOperario.value = inputOperario.value == "" ? nombreApellido[0][0] + nombreApellido[1][0] : inputOperario.value + '/' + nombreApellido[0][0] + nombreApellido[1][0];
            this.selectedIndex = 0;
        }
    }


    //para obtener los valores de los inputs en general
    function guardarDatosFiltro() {
        var datos = DatosFiltro();

        console.log("datos : ", datos);

        fetch('@Url.Action("GuardarDatosDashBoard", "Home")', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(datos)
        })
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                if (data.respuesta.idRespuesta === 0 || data.respuesta.idRespuesta === 1) {
                    Swal.fire({
                        title: "Success!!",
                        text: "Se guardaro los datos.",
                        icon: "success",
                        button: "Aww yiss!"
                    });
                } else {
                    Swal.fire({
                        title: "Error",
                        text: data.respuesta.mensaje,
                        icon: "error",
                        button: "OK",
                    });
                }
            })
            .catch(function (error) {
                console.error("Error:", error);
                Swal.fire({
                    title: "Error",
                    text: "Error en la solicitud.",
                    icon: "error",
                    button: "OK",
                });
            });

    }

    function DatosFiltro() {
        var tabla = document.getElementById("FiltroCentrifugo");
        var filasTr = tabla.querySelector('tbody').getElementsByTagName('tr');
        var datos = [];
        for (var i = 0; i < filasTr.length; i++) {
            var valores = obtenerValoresFila(filasTr[i]);
            valores["IdReporteFiltro"] = datosOperario.IdSitio + "-O&M-FOR-01-" + obtenerFecha("format");
            valores["IdDetalleFiltro"] = datosOperario.IdSitio + "-FiltroCentrifugo-" + i + "-" + valores["numeroGenerador"] + "-" + obtenerFecha("format");
            datos.push(valores);
        }
        return datos;
    }

    function obtenerValoresFila(fila) {
        var valores = {};

        for (var i = 0; i < fila.cells.length; i++) {
            var input = fila.cells[i].querySelector('input');
            var idClass = input.getAttribute("id-class");

            if (input.value === "") {
                input.focus();
            } else {
                if (input.type === 'number') {
                    valores[idClass] = parseFloat(input.value);
                } else {
                    valores[idClass] = input.value;
                }
            }
        }

        return valores;
    }


</script>

<script>
    /*
     activar para la continuidad de los divs
    var intervalId;
     var currentDiv = 1;
     var totalDivs = 2; // Actualizar el número total de divs

     window.onload = function () {
         startAutoToggle();
     };

     function toggleVisibility() {
         clearInterval(intervalId);
         currentDiv = (currentDiv % totalDivs) + 1;
         showDiv();
         intervalId = setInterval(function () {
             currentDiv = (currentDiv % totalDivs) + 1;
             showDiv();
         }, 5000);
     }

     function startAutoToggle() {
         intervalId = setInterval(function () {
             currentDiv = (currentDiv % totalDivs) + 1;
             showDiv();
         }, 1000);
     }

     function showDiv() {
         for (var i = 1; i <= totalDivs; i++) {

             var div = document.getElementById('div' + i);
             console.log("div ", div);
             if (i === currentDiv) {
                 div.classList.remove('hidden');
             } else {
                 div.classList.add('hidden');
             }
         }
     }*/
</script>

<script>
    // Obtén el elemento del input por su id
    var fechaInput = document.getElementById("fechaInput");
    var fechaInput2 = document.getElementById("fechaInput2");

    fechaInput2.addEventListener('change', function () {
        // Obtén el valor actual del input
        var valorInput = fechaInput2.value;

        // Intenta analizar el valor como una fecha
        var fechaParseada = new Date(valorInput);

        // Verifica si la fecha es válida
        if (!isNaN(fechaParseada.getTime())) {
            // La fecha es válida, actualiza el valor del input formateado
            fechaInput2.value = formatDate(fechaParseada);
        }
        // Si la fecha no es válida, el usuario ingresó algo que no es una fecha,
        // entonces podrías manejarlo de acuerdo a tus necesidades
    });
    // Agrega un evento de cambio al input
    fechaInput.addEventListener('change', function () {
        // Obtén el valor actual del input
        var valorInput = fechaInput.value;

        // Intenta analizar el valor como una fecha
        var fechaParseada = new Date(valorInput);

        // Verifica si la fecha es válida
        if (!isNaN(fechaParseada.getTime())) {
            // La fecha es válida, actualiza el valor del input formateado
            fechaInput.value = formatDate(fechaParseada);
        }
        // Si la fecha no es válida, el usuario ingresó algo que no es una fecha,
        // entonces podrías manejarlo de acuerdo a tus necesidades
    });

    // Función para formatear la fecha como "DD/MM/YYYY"
    function formatDate(date) {
        var day = date.getDate();
        var month = date.getMonth() + 1; // Los meses en JavaScript van de 0 a 11
        var year = date.getFullYear();

        // Agrega ceros a la izquierda si es necesario
        if (day < 10) {
            day = '0' + day;
        }

        if (month < 10) {
            month = '0' + month;
        }

        return day + '/' + month + '/' + year;
    }
</script>



